<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="I was asked to explore the possibility of having haproxy balance connections between multiple backend FTP servers. Luckily there is a way to do this without having to play with DNAT on the proxy...">
        <meta name="keywords" content="ftp, haproxy">
        <link rel="icon" href="https://oldmantaiter.dev/favicon.ico">

        <title>FTP Load-Balanced through haproxy - oldmantaiter</title>

        <!-- Stylesheets -->
        <link href="https://oldmantaiter.dev/theme/css/all.min.css" rel="stylesheet">
        <!-- /Stylesheets -->

        <!-- RSS Feeds -->
        <link href="https://oldmantaiter.dev/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="oldmantaiter Full Atom Feed" />
        <link href="https://oldmantaiter.dev/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="oldmantaiter Full RSS Feed" />
        <link href="https://oldmantaiter.dev/feeds/linux.atom.xml" type="application/atom+xml" rel="alternate" title="oldmantaiter Categories Atom Feed" />
        <link href="https://oldmantaiter.dev/feeds/linux.rss.xml" type="application/rss+xml" rel="alternate" title="oldmantaiter Categories RSS Feed" />
        <!-- /RSS Feeds -->

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

        <!-- Google Analytics -->
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-45723915-1', 'auto');
          ga('send', 'pageview');
        </script>
        <!-- /Google Analytics -->

    </head>

    <body>

        <!-- Header -->
    <div class="header-container gradient">

            <!-- Static navbar -->
            <div class="container">
                <div class="header-nav">
                    <div class="header-logo">
                        <a class="pull-left" href="https://oldmantaiter.dev/">oldmantaiter</a>
                    </div>
                    <div class="nav pull-right">
                    </div>
                </div>
            </div>
            <!-- /Static navbar -->

            <!-- Header -->
    <!-- Header -->
    <div class="container header-wrapper">
        <div class="row">
              <div class="col-lg-12">
                  <div class="header-content">
                      <h1 class="header-title">FTP Load-Balanced through haproxy</h1>
                      <p class="header-date">By <a href="https://oldmantaiter.dev/author/tait-clarridge.html">Tait Clarridge</a>, Fri 14 September 2012, Category <a href="https://oldmantaiter.dev/category/linux.html">Linux</a></p>
                      <div class="header-underline"></div>
                      <div class="clearfix"></div>
                      <p class="pull-right header-tags">
                          <span class="glyphicon glyphicon-tags mr5" aria-hidden="true"></span>
<a href="https://oldmantaiter.dev/tag/ftp.html">ftp</a>, <a href="https://oldmantaiter.dev/tag/haproxy.html">haproxy</a>                      </p>
                  </div>
              </div>
        </div>
    </div>
    <!-- /Header -->
            <!-- /Header -->

        </div>
        <!-- /Header -->


        <!-- Content -->
    <div class="container content">
        <p>I was asked to explore the possibility of having haproxy balance connections between multiple backend FTP servers. Luckily there is a way to do this without having to play with DNAT on the proxy server and instead setting it up with multiple backends in haproxy.</p>
<p>First you will need to setup a few FTP servers. I chose VSFTP (which can be installed on CentOS via &quot;yum install vsftpd&quot;)</p>
<p>As far as I know, this will only work properly with ftp passive mode. For that you can make the following vsftpd config</p>
<div class="highlight"><pre><span></span><span class="gp">[tait@foxtrot-tango-papa01 ~]$</span> cat /etc/vsftpd/vsftpd.conf
<span class="go">anonymous_enable=NO</span>
<span class="go">local_enable=YES</span>
<span class="go">write_enable=YES</span>
<span class="go">local_umask=022</span>
<span class="go">dirmessage_enable=YES</span>
<span class="go">xferlog_enable=YES</span>
<span class="go">connect_from_port_20=NO</span>
<span class="go">xferlog_file=/var/log/xferlog</span>
<span class="go">xferlog_std_format=YES</span>
<span class="go">pam_service_name=vsftpd</span>

<span class="gp">#</span> This is a user whitelist we use
<span class="go">userlist_enable=YES</span>
<span class="go">userlist_deny=NO</span>
<span class="go">userlist_file=/etc/vsftpd/user_list</span>
<span class="go">tcp_wrappers=YES</span>
<span class="go">pasv_enable=YES</span>
<span class="go">pasv_promiscuous=NO</span>
<span class="go">port_enable=YES</span>
<span class="go">port_promiscious=NO</span>

<span class="gp">#</span> Added listen address <span class="k">for</span> internal only
<span class="go">listen=YES</span>
<span class="gp">#</span> If you use this method, change the listen_address <span class="k">for</span> each server <span class="o">(</span>duh<span class="o">)</span>
<span class="go">listen_address=10.0.0.10</span>

<span class="gp">#</span> These are the ports to use <span class="k">for</span> PASV mode
<span class="gp">#</span> It is important that these port numbers are unique across each of your backend servers
<span class="go">pasv_min_port=10000</span>
<span class="go">pasv_max_port=10250</span>
</pre></div>
<p>So basically for each server you should be creating a new port range to use with passive ftp.
My configuration has the following:</p>
<p>foxtrot-tango-papa01: 10001 -&gt; 10250
foxtrot-tango-papa02: 10251 -&gt; 10500
foxtrot-tango-papa03: 10501 -&gt; 10750</p>
<p>Ensure that your configuration works on each node and try sample ftp connections to each of your servers before we proceed to configuring and using haproxy for the frontend.</p>
<p>Download and install haproxy, you can either do this by source or through a 3rd party repository.</p>
<p>This is what my config (very basic) looks like.</p>
<div class="highlight"><pre><span></span><span class="gp">[tait@ftp-proxy01]$</span> cat /etc/haproxy/haproxy.cfg
<span class="gp">#</span> HAPROXY Config <span class="k">for</span> FTP
<span class="gp">#</span> my apologies <span class="k">for</span> the spacing
<span class="go">global</span>
<span class="go">    log 127.0.0.1 local0 info</span>
<span class="go">    chroot /var/lib/haproxy</span>
<span class="go">    user haproxy</span>
<span class="go">    group haproxy</span>
<span class="go">    maxconn 2000</span>

<span class="go">defaults</span>
<span class="go">    log global</span>
<span class="go">    mode tcp</span>
<span class="go">    option tcplog</span>
<span class="go">    retries 3</span>

<span class="gp">#</span> This is <span class="k">for</span> the initial connection and control traffic
<span class="go">frontend foxtrot-tango-papa-control</span>
<span class="go">    bind *:21</span>
<span class="go">    default_backend ftp_server_pool</span>

<span class="gp">#</span> Each of these frontends represent a server and its corresponding PASV ports we <span class="nb">set</span>
<span class="go">frontend foxtrot-tango-papa01</span>
<span class="go">    bind *:10001-10250</span>
<span class="go">    default_backend foxtrot_tango_papa01</span>

<span class="go">frontend foxtrot-tango-papa02</span>
<span class="go">    bind *:10251-10500</span>
<span class="go">    default_backend foxtrot_tango_papa02</span>

<span class="go">frontend foxtrot-tango-papa03</span>
<span class="go">    bind *:10501-10750</span>
<span class="go">    default_backend foxtrot_tango_papa03</span>

<span class="gp">#</span> Global backend <span class="k">for</span> the ftp control traffic to find a server
<span class="go">backend ftp_server_pool</span>
<span class="go">    server foxtrot-tango-papa01 10.0.0.10 check port 21 inter 10s rise 1 fall 2</span>
<span class="go">    server foxtrot-tango-papa02 10.0.0.11 check port 21 inter 10s rise 1 fall 2</span>
<span class="go">    server foxtrot-tango-papa03 10.0.0.12 check port 21 inter 10s rise 1 fall 2</span>

<span class="gp">#</span> Backends <span class="k">for</span> each of our FTP servers
<span class="go">backend foxtrot_tango_papa01</span>
<span class="go">    server foxtrot-tango-papa01 10.0.0.10 check port 21 inter 10s rise 1 fall 2</span>

<span class="go">backend foxtrot_tango_papa02</span>
<span class="go">    server foxtrot-tango-papa02 10.0.0.11 check port 21 inter 10s rise 1 fall 2</span>

<span class="go">backend foxtrot_tango_papa03</span>
<span class="go">    server foxtrot-tango-papa03 10.0.0.12 check port 21 inter 10s rise 1 fall 2</span>
</pre></div>
<p>Now you should be able to start haproxy (ignore warnings or take care of them as you need to... like I said, very basic config) and ftp to it.</p>
<p>Be warned, this configuration makes haproxy bind to EVERY passive port listed, but you should be able to ftp to the haproxy IP and transfer files to and from your FTP server pool.</p>
<p>Leave a comment if you require any help, but as a basic config this should work.</p>



            <div class="comments">
                <div id="disqus_thread"></div>
                    <script type="text/javascript">
                        var disqus_shortname = 'oldmantaiter';
                        var disqus_identifier = 'techlog/2012/09/ftp-load-balanced-through-haproxy.html';
                        var disqus_url = 'https://oldmantaiter.dev/techlog/2012/09/ftp-load-balanced-through-haproxy.html';
                        (function() {
                            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                        })();
                    </script>
                <noscript>Please enable JavaScript to view the comments.</noscript>
            </div>
    </div>
        <!-- /Content --> 

        <!-- Footer -->
        <div class="footer gradient-2">
            <div class="container footer-container ">
                <div class="row">
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Sitemap</div>
                        <ul class="list-unstyled">
                            <li><a href="https://oldmantaiter.dev/archives.html">Archives</a></li>
                            <li><a href="https://oldmantaiter.dev/tags.html">Tags</a></li>
                            <li><a href="https://oldmantaiter.dev/authors.html">Authors</a></li>
                            <li><a href="https://oldmantaiter.dev/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">Atom Feed</a></li>
                            <li><a href="https://oldmantaiter.dev/feeds/all.rss.xml" type="application/rss+xml" rel="alternate">RSS Feed</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Social</div>
                        <ul class="list-unstyled">
                            <li><a href="https://github.com/oldmantaiter/" target="_blank">Github</a></li>
                            <li><a href="https://twitter.com/oldmantaiter" target="_blank">Twitter</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                    </div> 
                    <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
                        <p class="pull-right text-right">
                            <small><em>Proudly powered by <a href="http://docs.getpelican.com/" target="_blank">pelican</a></em></small><br/>
                            <small><em>Theme and code by <a href="http://www.molivier.com/" target="_blank">molivier</a></em></small><br/>
                            <small>&copy; Tait Clarridge 2019</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Footer -->
    </body>
</html>