<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Recently I set up Openfire as a corporate messaging service, the problem I ran into was that since our VPN server and Openfire server both have external access and are in the same address space, the ...">
        <meta name="keywords" content="firewall, iptables, linux">
        <link rel="icon" href="../../../favicon.ico">

        <title>iptables - Route Traffic from Specific Interface to a Specific Gateway - oldmantaiter</title>

        <!-- Stylesheets -->
        <link href="../../../theme/css/all.min.css" rel="stylesheet">
        <!-- /Stylesheets -->

        <!-- RSS Feeds -->
        <link href="http://oldmantaiter.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="oldmantaiter Full Atom Feed" />
        <link href="http://oldmantaiter.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="oldmantaiter Full RSS Feed" />
        <link href="http://oldmantaiter.github.io/feeds/linux.atom.xml" type="application/atom+xml" rel="alternate" title="oldmantaiter Categories Atom Feed" />
        <link href="http://oldmantaiter.github.io/feeds/linux.rss.xml" type="application/rss+xml" rel="alternate" title="oldmantaiter Categories RSS Feed" />
        <!-- /RSS Feeds -->

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

        <!-- Google Analytics -->
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-45723915-1', 'auto');
          ga('send', 'pageview');
        </script>
        <!-- /Google Analytics -->

    </head>

    <body>

        <!-- Header -->
    <div class="header-container gradient">

            <!-- Static navbar -->
            <div class="container">
                <div class="header-nav">
                    <div class="header-logo">
                        <a class="pull-left" href="../../../">oldmantaiter</a>
                    </div>
                    <div class="nav pull-right">
                            <a href="../../../about.html">About</a>
                            <a href="../../../archives.html">Archives</a>
                    </div>
                </div>
            </div>
            <!-- /Static navbar -->

            <!-- Header -->
    <!-- Header -->
    <div class="container header-wrapper">
        <div class="row">
              <div class="col-lg-12">
                  <div class="header-content">
                      <h1 class="header-title">iptables - Route Traffic from Specific Interface to a Specific Gateway</h1>
                      <p class="header-date">By <a href="../../../author/tait-clarridge.html">Tait Clarridge</a>, Thu 29 October 2009, Category <a href="../../../category/linux.html">Linux</a></p>
                      <div class="header-underline"></div>
                      <div class="clearfix"></div>
                      <p class="pull-right header-tags">
                          <span class="glyphicon glyphicon-tags mr5" aria-hidden="true"></span>
<a href="../../../tag/firewall.html">firewall</a>, <a href="../../../tag/iptables.html">iptables</a>, <a href="../../../tag/linux.html">linux</a>                      </p>
                  </div>
              </div>
        </div>
    </div>
    <!-- /Header -->
            <!-- /Header -->

        </div>
        <!-- /Header -->


        <!-- Content -->
    <div class="container content">
        <p>Recently I set up Openfire as a corporate messaging service, the problem I ran into was that since our VPN server and Openfire server both have external access and are in the same address space, the VPN server would try to send the Openfire traffic out the external gateway but couldn't reach the server because of some ACLs that were set in place.</p>
<p>So what I did was take the traffic from the VPN tunnel that is going to the Openfire ports and route it through our internal network.</p>
<p>What you will need to do is create another route table and mark the desired packets with iptables.</p>
<p>First you should pick a table number to create, I picked table #300. I made sure that the table did not exist before creating it by doing the following:</p>
<div class="highlight"><pre><span class="gp">[root@tclarrltp ~]#</span> ip route show table 300
</pre></div>
<p>This shouldn't return any information, if it does you must select a new one as it already contains routing data and overwriting it will most likely cause some issues.</p>
<p>Now that we know that the table doesn't exist, we are going to clear it anyways to make sure that it is clean.</p>
<div class="highlight"><pre><span class="gp">[root@tclarrltp ~]#</span> ip route flush table 300
</pre></div>
<p>You may or may not get a message telling you that there was nothing to flush or it doesn't exist.</p>
<p>Next we have to pick a number to have iptables mark the packets with. I chose the number 85 because in one of my previous posts I had used 80 to do some custom routing.</p>
<p>To set an ip rule we need to figure out the hex value of the number above. The easiest way to do this is in a calculator that can display hex and decimal values. In GNOME you can select the calculator from Applications &gt; Accessories &gt; Calculator, then select View &gt; Programming. To make the conversion, make sure that the &quot;Dec&quot; radio button is selected and type in the number you want (eg. 85). Now click the &quot;Hex&quot; radio button and it will give you the hex value. 85 becomes 55 so our rule will use 0x55 as the hex value. As I don't have a great understanding of hex, I am not sure if larger numbers would mean that the &quot;0x&quot; part preceding the hex value from the calculator would change.</p>
<p>Now we should check to make sure that no ip rule exists for our hex value.</p>
<div class="highlight"><pre><span class="gp">[root@tclarrltp ~]#</span> ip rule
</pre></div>
<p>This will show all the rules that are active, if there is an entry that has 0x55 in it, pick another number.</p>
<p>Next, flush the rule to make it clean for us to use.</p>
<div class="highlight"><pre><span class="gp">[root@tclarrltp ~]#</span> ip rule del fwmark 0x55
</pre></div>
<p>You will probably get a message that states &quot;RTNETLINK answers: No such file or directory&quot;, this is a good thing and means that it really does not exist.</p>
<p>So now we are ready to start creating the iptables rules, I do these first but you can do them after creating the routing rules if you would like (those will follow this section).</p>
<p>Our Openfire installation uses a custom port, but I will show this with the default ports (tcp ports 5222 and 5223). This will work for any port you would like. Our OpenVPN setup uses tun0 as the tunnel adaptor so that is the interface we wish to forward packets from.</p>
<p>We are going to use the PREROUTING table as we need to mark the packets before they get routed.</p>
<div class="highlight"><pre><span class="gp">[root@tclarrltp ~]#</span> iptables -t mangle -A PREROUTING -j MARK --set-mark <span class="m">85</span> -i tun0 -p tcp --dport 5222
<span class="gp">[root@tclarrltp ~]#</span> iptables -t mangle -A PREROUTING -j MARK --set-mark <span class="m">85</span> -i tun0 -p tcp --dport 5223
</pre></div>
<p>As you can see, the --set-mark flag value is our number that we picked in a previous section. It correlates to the fwmark 0x55 rule that we will be creating (because they are equal values, just one is decimal and the other is hex).</p>
<p>The -i flag is the interface we want iptables to mark packets from.</p>
<p>The -p flag is for the protocol (tcp/udp) and the -dport flag is the destination port of the packets.</p>
<p>This basically means that any traffic coming through tun0 heading for tcp port 5222 or 5223 will get marked with the number 85.</p>
<p>So now we can set the routing rules to deal with the marked packets.</p>
<p>First we are going to set the default route for table 300 so all our marked packets will go through there. I am going to use 192.168.0.1 as the gateway.</p>
<div class="highlight"><pre><span class="gp">[root@tclarrltp ~]#</span> ip route add table <span class="m">300</span> default via 192.168.0.1
<span class="go"># Now tell the rule which table to look up</span>
<span class="gp">[root@tclarrltp ~]#</span> ip rule add fwmark 0x55 table 300
</pre></div>
<p>Remember that unless you make the rule persistent or have a script start on boot with these commands, the routing will not be there when you restart your machine.</p>
<p>A simple script would look like the following:</p>
<div class="highlight"><pre><span class="c">#!/bin/bash</span>

ip route flush table 300
ip rule del fwmark 0x55
iptables -t mangle -A PREROUTING -j MARK --set-mark <span class="m">85</span> -i tun0 -p tcp --dport 5222
iptables -t mangle -A PREROUTING -j MARK --set-mark <span class="m">85</span> -i tun0 -p tcp --dport 5223
ip route add table <span class="m">300</span> default via 192.168.0.1
ip rule add fwmark 0x55 table 300
</pre></div>
<p>If you have any questions, feel free to leave me a comment or send me an email.</p>



            <div class="comments">
                <div id="disqus_thread"></div>
                    <script type="text/javascript">
                        var disqus_shortname = 'oldmantaiter';
                        var disqus_identifier = 'techlog/2009/10/iptables-route-traffic-from-specific-interface-to-a-specific-gateway.html';
                        var disqus_url = '../../../techlog/2009/10/iptables-route-traffic-from-specific-interface-to-a-specific-gateway.html';
                        (function() {
                            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                        })();
                    </script>
                <noscript>Please enable JavaScript to view the comments.</noscript>
            </div>
    </div>
        <!-- /Content --> 

        <!-- Footer -->
        <div class="footer gradient-2">
            <div class="container footer-container ">
                <div class="row">
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Sitemap</div>
                        <ul class="list-unstyled">
                            <li><a href="../../../archives.html">Archives</a></li>
                            <li><a href="../../../tags.html">Tags</a></li>
                            <li><a href="../../../authors.html">Authors</a></li>
                            <li><a href="http://oldmantaiter.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">Atom Feed</a></li>
                            <li><a href="http://oldmantaiter.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate">RSS Feed</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Social</div>
                        <ul class="list-unstyled">
                            <li><a href="https://github.com/oldmantaiter/" target="_blank">Github</a></li>
                            <li><a href="https://twitter.com/oldmantaiter" target="_blank">Twitter</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                    </div> 
                    <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
                        <p class="pull-right text-right">
                            <small><em>Proudly powered by <a href="http://docs.getpelican.com/" target="_blank">pelican</a></em></small><br/>
                            <small><em>Theme and code by <a href="http://www.molivier.com/" target="_blank">molivier</a></em></small><br/>
                            <small>&copy; Tait Clarridge 2015</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Footer -->
    </body>
</html>